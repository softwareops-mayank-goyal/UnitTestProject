name: AI Code Review

on:
  push: #Any Brach

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Needed so we can diff against the base branch
          fetch-depth: 0

      - name: Compute diff for this PR
        id: diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git diff "$BASE_SHA" "$HEAD_SHA" > diff.txt
          echo "Diff size: $(wc -c < diff.txt) bytes"

      - name: Install OpenAI SDK
        run: |
          python -m pip install --upgrade pip
          python -m pip install "openai>=1.0.0"

      - name: Run AI review
        id: ai_review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_KEY }}
        run: |
          python .github/scripts/ai_review.py < diff.txt > review.md
          echo 'review<<EOF' >> $GITHUB_OUTPUT
          cat review.md >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Post AI review as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = String.raw`${{ steps.ai_review.outputs.review }}`;
            if (!body.trim() || body.includes("No relevant changes detected.")) {
              core.info("No meaningful AI review output, skipping comment.");
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
