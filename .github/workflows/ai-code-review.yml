name: AI Code Review

on:
  push:               # any branch push
  pull_request:       # PR opened/updated

jobs:
  ai-review:
    runs-on: [self-hosted, Windows, X64]
    permissions:
      contents: read
      pull-requests: write   # needed only for PR comment; harmless on push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug git on runner
        shell: powershell
        run: |
          echo "PATH:"
          echo $env:PATH
          git --version

      - name: Compute diff for this event
        shell: powershell
        id: diff
        run: |
          $eventName = "${{ github.event_name }}"

          if ($eventName -eq "pull_request") {
            Write-Host "Event is pull_request"
            $BASE_SHA = "${{ github.event.pull_request.base.sha }}"
            $HEAD_SHA = "${{ github.event.pull_request.head.sha }}"
          }
          else {
            Write-Host "Event is push"
            $BASE_SHA = "${{ github.event.before }}"
            $HEAD_SHA = "${{ github.sha }}"
          }

          Write-Host "Base SHA: $BASE_SHA"
          Write-Host "Head SHA: $HEAD_SHA"

          # Handle first commit / invalid base SHA
          if ([string]::IsNullOrEmpty($BASE_SHA) -or
              $BASE_SHA -eq "0000000000000000000000000000000000000000") {

            Write-Host "No valid base SHA; using last commit only"
            git show $HEAD_SHA | Out-File -FilePath diff.txt -Encoding utf8
          }
          else {
            git diff $BASE_SHA $HEAD_SHA | Out-File -FilePath diff.txt -Encoding utf8
          }

          $size = (Get-Item diff.txt).Length
          Write-Host "Diff size: $size bytes"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install OpenAI SDK
        run: |
          python -m pip install --upgrade pip
          python -m pip install "openai>=1.0.0"

      - name: Run AI review
        id: ai_review
        shell: powershell
        env:
          # must match your repo secret names
          AZURE_API_KEY: ${{ secrets.AZURE_API_KEY }}
          AZUREAPI: ${{ secrets.AZUREAPI }}
          AZURE_API_VERSION: ${{ secrets.AZURE_API_VERSION }}
          AZURE_DEPLOYMENT: gpt-4o
        run: |
          echo "Workspace is: $env:GITHUB_WORKSPACE"
          ls -R .
          Get-Content diff.txt | python "$env:GITHUB_WORKSPACE/.github/scripts/ai_review.py" < diff.txt > review.md
          echo 'review<<EOF' >> $env:GITHUB_OUTPUT
          cat review.md >> $env:GITHUB_OUTPUT
          echo 'EOF' >> $env:GITHUB_OUTPUT

      - name: Attach AI review to Summary (push)
        if: github.event_name == 'push'
        run: |
          echo "### ðŸ§  AI Code Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat review.md >> $GITHUB_STEP_SUMMARY

      - name: Post AI review as PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = String.raw`${{ steps.ai_review.outputs.review }}`;
            if (!body.trim() || body.includes("No relevant changes detected.")) {
              core.info("No meaningful AI review output, skipping comment.");
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
