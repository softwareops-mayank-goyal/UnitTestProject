name: AI Code Review

on:
  push:               # any branch push
  pull_request:       # PR opened/updated

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write   # needed only for PR comment; harmless on push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute diff for this event
        id: diff
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Event is pull_request"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            echo "Event is push"
            # 'before' is the previous commit on this branch
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          # In some cases (first commit, force-push etc.), before can be all zeros
          if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE_SHA" ]; then
            echo "No valid base SHA; using last commit only"
            git show "$HEAD_SHA" > diff.txt
          else
            git diff "$BASE_SHA" "$HEAD_SHA" > diff.txt
          fi

          echo "Diff size: $(wc -c < diff.txt) bytes"

      - name: Install OpenAI SDK
        run: |
          python -m pip install --upgrade pip
          python -m pip install "openai>=1.0.0"

      - name: Run AI review
        id: ai_review
        env:
          # Make sure this matches your repo secret name
          OPENAI_API_KEY: ${{ secrets.OPENAI_KEY }}
        run: |
          python .github/scripts/ai_review.py < diff.txt > review.md
          echo 'review<<EOF' >> $GITHUB_OUTPUT
          cat review.md >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Attach AI review to Summary (push)
        if: github.event_name == 'push'
        run: |
          echo "### ðŸ§  AI Code Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat review.md >> $GITHUB_STEP_SUMMARY

      - name: Post AI review as PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = String.raw`${{ steps.ai_review.outputs.review }}`;
            if (!body.trim() || body.includes("No relevant changes detected.")) {
              core.info("No meaningful AI review output, skipping comment.");
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
