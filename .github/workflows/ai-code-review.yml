name: AI Code Review

on:
  push:               # any branch push
  pull_request:       # PR opened/updated

jobs:
  ai-review:
    runs-on: [self-hosted, Windows, X64]
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug git on runner
        shell: powershell
        run: |
          echo "PATH:"
          echo $env:PATH
          git --version

      - name: Compute diff for this event
        shell: powershell
        id: diff
        run: |
          $eventName = "${{ github.event_name }}"

          if ($eventName -eq "pull_request") {
            Write-Host "Event is pull_request"
            $BASE_SHA = "${{ github.event.pull_request.base.sha }}"
            $HEAD_SHA = "${{ github.event.pull_request.head.sha }}"
          }
          else {
            Write-Host "Event is push"
            $BASE_SHA = "${{ github.event.before }}"
            $HEAD_SHA = "${{ github.sha }}"
          }

          Write-Host "Base SHA: $BASE_SHA"
          Write-Host "Head SHA: $HEAD_SHA"

          if ([string]::IsNullOrEmpty($BASE_SHA) -or
              $BASE_SHA -eq "0000000000000000000000000000000000000000") {

            Write-Host "No valid base SHA; using last commit only"
            git show $HEAD_SHA | Out-File -FilePath diff.txt -Encoding utf8
          }
          else {
            git diff $BASE_SHA $HEAD_SHA | Out-File -FilePath diff.txt -Encoding utf8
          }

          $size = (Get-Item diff.txt).Length
          Write-Host "Diff size: $size bytes"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install OpenAI SDK
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          python -m pip install "openai>=1.0.0"

      - name: Run AI review
        id: ai_review
        shell: powershell
        env:
          AZURE_API_KEY: ${{ secrets.AZURE_API_KEY }}
          AZUREAPI: ${{ secrets.AZUREAPI }}
          AZURE_API_VERSION: ${{ secrets.AZURE_API_VERSION }}
          AZURE_DEPLOYMENT: gpt-4o
        run: |
          echo "Workspace is: $env:GITHUB_WORKSPACE"
          Get-ChildItem -Recurse .

          # 1) Run Python review script: diff.txt -> review_raw.md
          Get-Content diff.txt | python "$env:GITHUB_WORKSPACE/.github/scripts/ai_review.py" > review_raw.md

          # 2) Beautify Markdown for Teams
          $text = Get-Content review_raw.md -Raw

          # Headings â†’ smaller headings
          $text = $text -replace '## ', "`n`n### "

          # Bullets â†’ Unicode bullet (â€¢)
          $bullet = [char]0x2022
          $text   = $text -replace '- ', "$bullet "

          # Remove bold markers **...**
          $text = $text -replace '\*\*(.*?)\*\*', '$1'

          # Strip backticks
          $text = $text -replace '`', ''

          # Save pretty text for Teams & summary
          $text | Set-Content review_teams.txt -Encoding UTF8
          $text | Set-Content review.md -Encoding UTF8

          # 3) Expose as GitHub Action output
          Add-Content -Path $env:GITHUB_OUTPUT -Value "review<<EOF"
          Get-Content review_teams.txt | Add-Content -Path $env:GITHUB_OUTPUT
          Add-Content -Path $env:GITHUB_OUTPUT -Value "EOF"

      - name: Send AI review to Teams via Power Automate
        if: always()   # send even if review step failed
        shell: powershell
        env:
          TEAMS_WEBHOOK: ${{ secrets.POWERAUTOMATE_TEAMS_WEBHOOK_URL }}
          REVIEW_BODY:   ${{ steps.ai_review.outputs.review }}
        run: |
          if (-not $env:TEAMS_WEBHOOK) {
            Write-Host "No Teams webhook configured, skipping."
            exit 0
          }

          # Fallback if the AI step didnâ€™t produce anything
          $review = $env:REVIEW_BODY
          if ([string]::IsNullOrWhiteSpace($review)) {
            $review = "AI review completed but returned no detailed comments."
          }

          # Build payload compatible with your existing flow,
          # plus one extra field: aiReview
          $payload = @{
            repo       = "$env:GITHUB_REPOSITORY"
            branch     = "$env:GITHUB_REF_NAME"
            actor      = "$env:GITHUB_ACTOR"
            message    = "${{ github.event.head_commit.message }}"
            compareUrl = "${{ github.event.compare }}"
            aiReview   = $review
          }

          $json = $payload | ConvertTo-Json -Depth 6

          Write-Host "Payload to Teams:"
          Write-Host $json

          Invoke-RestMethod `
            -Uri $env:TEAMS_WEBHOOK `
            -Method Post `
            -ContentType 'application/json' `
            -Body $json

          Write-Host "AI review sent to Teams."

      - name: Attach AI review to Summary (push)
        if: github.event_name == 'push'
        shell: powershell
        run: |
          "### ðŸ§  AI Code Review" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          Get-Content review.md | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

      - name: Post AI review as PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = String.raw`${{ steps.ai_review.outputs.review }}`;
            if (!body.trim() || body.includes("No relevant changes detected.")) {
              core.info("No meaningful AI review output, skipping comment.");
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
